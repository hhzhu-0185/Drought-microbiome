---
title: "Fig.3f_Fungal differential taxonomy"
author: "Huanhuan Zhu"
date: "2025-10-09"
output: html_document
---

```{r, fig.align='center', fig.height=5.2, fig.width=10, warning=FALSE, message=FALSE}

#############################Fig.3f_Fungal differential taxonomy##########################

library(dplyr)  # to use count/everything
library(RColorBrewer)
library(tidyverse)  # %>%
library(reshape2)  # melt
library(patchwork)
library(ggplot2)
library(ggh4x)
library(Maaslin2)
library(data.table)
library(tidyverse)

setwd("E:/HMME/Amplicon/4-data analysis/amplicon(zhh)/Result/Fungi/otu2/")

rm(list = ls())

otu_id_with_traits <- readRDS("otu_id_with_traits.rds")

otu_all0 <- as.data.frame(fread("otu_fungFlattening_rrncor.csv"))
otu_all0 <- column_to_rownames(otu_all0,"V1")
otu_all0 <- as.data.frame(t(otu_all0))

otu_all1_z <- otu_all0[grepl("TS", rownames(otu_all0)),]

metadata <-data.frame("id" = rownames(otu_all1_z), "group" = as.numeric(substr(rownames(otu_all1_z),1,1))) 
metadata <- column_to_rownames(metadata,"id")

fit_data <- Maaslin2(
  input_data = otu_all1_z,
  input_metadata = metadata,
  min_abundance = 0.001,
  min_prevalence = 0.1,
  min_variance = 0.0,
  output = "D:/Rtmp",
  normalization = "none",
  transform = "LOG",
  analysis_method = "LM",
  cores = 1,
  fixed_effects = c("group"),
  random_effects = NULL, 
  plot_scatter = FALSE
)

rp1 <- fit_data$results

colnames(rp1)[1] = "otu"

rp1$type <- "none"
rp1[rp1$coef > 0.00 & rp1$qval <0.05,]$type <- "Up"
rp1[rp1$coef <= 0.00 & rp1$qval <0.05,]$type <- "Down"
rp1[rp1$qval >= 0.05,]$type <- "Stable"

############

group <- read.csv("HMME.fung.OTU.ID1.csv")

rp1 <- left_join(rp1, group, by=c("otu"="OTU.ID"))
rp1 <- separate(rp1,V5_6, sep = "__", into = c("pre_V5_6", "V5_6"))
rp1 <- separate(rp1,V5_6, sep = "_", into = c("V5_6"))

library(ggplot2)
library(dplyr)

library(data.table)

my_function <- function(){
  otu_all0<- as.data.frame(fread("otu_fungFlattening_rrncor.csv"))
  otu_all0 <- column_to_rownames(otu_all0,"V1")
  
  metadata <- read.csv("sample_metadata.csv")
  metadata <- metadata[metadata$sample.id %in% colnames(otu_all0),]
  
  otu_all_z <- otu_all0[rp2$otu, metadata[metadata$compartment=="S" & metadata$treatment=="T",]$sample.id]
  
  otu_all_z$otu <- rownames(otu_all_z)
  
  otu_all_z <- merge(otu_all_z, rp2[,c("V5_6","otu")], by="otu")
  otu_all_z1 <- aggregate(.~V5_6,otu_all_z[,2:68], FUN="sum")
  otu_all_z1 <- as.data.frame(t(column_to_rownames(otu_all_z1,"V5_6")))
  otu_all_z1$sample.id <- rownames(otu_all_z1)
  otu_all_z1 <- merge(otu_all_z1, metadata[,c("sample.id","generation")], by="sample.id")
  otu_all_z1 <- aggregate(.~generation,otu_all_z1[,2:ncol(otu_all_z1)], FUN="mean")
  
  otu_all_z2 <- reshape2::melt(otu_all_z1, id="generation")
  
  order_new1 <- aggregate(value~variable,otu_all_z2, FUN="mean")
  #order_new1 <- order_new1[!grepl("uncultured|Candidatus|_", order_new1$variable), ]
  
  order_new1 <- order_new1[order(order_new1$value,decreasing = T),]
  order_new1 <- order_new1[1:15, ]

  levels(otu_all_z2$variable) <- c(levels(otu_all_z2$variable), "Others")
  
  otu_all_z2[!(otu_all_z2$variable %in% order_new1$variable),]$variable <- "Others"
  
  otu_all_z2_tmp <<- otu_all_z2
  order_new1 <<- order_new1
}

rp2 <- rp1[rp1$type!="Stable",]
my_function()
otu_all_order <- otu_all_z2_tmp


my_function <- function(){
  otu_all0<- as.data.frame(fread("otu_fungFlattening_rrncor.csv"))
  otu_all0 <- column_to_rownames(otu_all0,"V1")
  
  metadata <- read.csv("sample_metadata.csv")
  metadata <- metadata[metadata$sample.id %in% colnames(otu_all0),]
  
  otu_all_z <- otu_all0[rp2$otu, metadata[metadata$compartment=="S" & metadata$treatment=="T",]$sample.id]
  
  otu_all_z$otu <- rownames(otu_all_z)
  
  otu_all_z <- merge(otu_all_z, rp2[,c("V5_6","otu")], by="otu")
  otu_all_z1 <- aggregate(.~V5_6,otu_all_z[,2:68], FUN="sum")
  otu_all_z1 <- as.data.frame(t(column_to_rownames(otu_all_z1,"V5_6")))
  otu_all_z1$sample.id <- rownames(otu_all_z1)
  otu_all_z1 <- merge(otu_all_z1, metadata[,c("sample.id","generation")], by="sample.id")
  otu_all_z1 <- aggregate(.~generation,otu_all_z1[,2:ncol(otu_all_z1)], FUN="mean")
  
  otu_all_z2 <- reshape2::melt(otu_all_z1, id="generation")
  
  order_new1 <- aggregate(value~variable,otu_all_z2, FUN="mean")
  
  order_new1 <- order_new1[order(order_new1$value,decreasing = T),]
  order_new1 <- order_new1[order_new1$variable %in%  unique(otu_all_order$variable), ]
  
  levels(otu_all_z2$variable) <- c(levels(otu_all_z2$variable), "Others")
  
  otu_all_z2[!(otu_all_z2$variable %in% order_new1$variable),]$variable <- "Others"
  otu_all_z2_tmp <<- otu_all_z2
  
}


rp2 <- rp1[rp1$type=="Up", ]
my_function()
otu_all_z2_up <- otu_all_z2_tmp
otu_all_z2_up$type <- "Up"

rp2 <- rp1[rp1$type=="Down", ]
my_function()
otu_all_z2_down <- otu_all_z2_tmp
otu_all_z2_down$type <- "Down"


otu_all_z2_all <- rbind(otu_all_z2_up, otu_all_z2_down)

rp1 <- left_join(rp1, otu_id_with_traits[,c("OTU.ID","Assembly_Length")], by=c("otu"="OTU.ID"))

# genome_size added
mean_gs <- aggregate(Assembly_Length~ V5_6, rp1, FUN="mean")
colnames(mean_gs)[2] <- "mean"

sd_gs <- aggregate(Assembly_Length~ V5_6, rp1, FUN="sd")
colnames(sd_gs)[2] <- "sd"

all_gs <- merge(mean_gs, sd_gs, by = "V5_6")


all_gs$all <- with(
  all_gs,
  paste0("italic('", V5_6, "')~'(", round(mean/1000000,2), " Mb)'")
)


colors <- c(
  "#E41A1C", # red
  "#377EB8", # blue
  "#4DAF4A", # green
  "#984EA3", # purple
  "#FF7F00", # orange
  "#FFFF33", # yellow
  "#A65628", # dark brown
  "#F781BF", # pink
  "#666666", # gray
  "#1B9E77", # dark teal
  "#D95F02", # deep orange
  "#6495ED", # muted blue
  "#E7298A", # deep pink
  "#66A61E", # olive green
  "#A6761D", # dark mustard
  "gray"  # dark gray
)


library(scales)
my_colors <- c(
  "Up" = alpha("#cd1936", 1),
  "Down" = alpha("#1445f8", 1)
)

strip_custom <- strip_themed(
  background_x = elem_list_rect(
    fill = my_colors,
    color = "black"
  ),
  text_x = elem_list_text(
    #face = "bold",
    colour = "white"
  )
)


# for rename fill
otu_all_z2_all <- merge(otu_all_z2_all, all_gs[,c("V5_6","all")], by.x="variable", by.y="V5_6", all.x=T)

phylum_labels <- unique(otu_all_z2_all[, c("variable", "all")])

phylum_labels_vec <- setNames(c(phylum_labels$all[1:10],"Others",phylum_labels$all[12:16]), phylum_labels$variable)
phylum_labels_vec[rev(c(as.character(order_new1$variable), "Others"))]


otu_all_z2_all$type <- factor(otu_all_z2_all$type, levels=c("Up", "Down"))
p <- ggplot(data = otu_all_z2_all, aes(x=generation,y=value/1000,fill=factor(variable,levels=rev(c(as.character(order_new1$variable), "Others"))))) +
  geom_col(position = "stack", width = 0.6)  +
  facet_wrap2(. ~ type,
              strip = strip_custom,
              labeller = labeller(type = c("Up" = "Increase", "Down" = "Decrease"))) +
  scale_fill_manual(name="Top 15 genus",values =  rev(colors), labels = function(x) parse(text = phylum_labels_vec[rev(c(as.character(order_new1$variable), "Others"))])) +
  guides(fill = guide_legend(
    override.aes = list(size = 2),
    keyheight    = unit(0.2, "lines"), 
    default.unit = "lines",
    label.vjust  = 0.5,
    label.theme  = element_text( 
      size = 20,
      margin = margin(t = -2.5, b = -2.5, l = 5)
    )
  )) +
  scale_y_continuous(labels = scales::percent) + 
  scale_x_continuous(breaks = 0:6) +
  labs(x="Generation", y="Relative abundance (%)", title="Fungi")+
  theme_bw() +
  theme(plot.title = element_text(color = "black", size = 30, hjust = 0.5),
        axis.title = element_text(color = "black", size = 26), 
        #axis.title.y = element_blank(), 
        axis.text.y = element_text(color = "black", size = 22),
        axis.text.x = element_text(color = "black", size = 22),
        legend.title = element_text(color = "black", size = 24),
        legend.text = element_text(color = "black", size = 20),
        strip.text = element_text(color = "black",size = 22),
        strip.background =element_rect(fill="lightgrey", size = 0)
  )

# 945 H500
print(p)


```

