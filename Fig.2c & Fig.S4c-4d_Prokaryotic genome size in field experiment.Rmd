---
title: 'Fig.2c & Fig.S4c-4d_Prokaryotic genome size in field experiment'
author: "Huanhuan Zhu"
date: "2025-09-19"
output: html_document
---

## Fig.2c_Prokaryotic genome size pre-flowering drought
```{r, fig.align='center', fig.height=5, fig.width=8.9, warning=FALSE, message=FALSE}

library(ggplot2)
library(ggpubr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(ggpubr)
library(gghalves)
library(ggsignif)
library(rstatix)

rm(list = ls())

#Fig.3c_Prokaryotic gs all

setwd("E:/epicon/")

genome_size <- read.csv("results-combined.csv")

wilcox_res <- wilcox.test(genome_size/1000000 ~ treatment, data = genome_size[genome_size$timepoint %in% c(3,4,8),])

W <- round(wilcox_res$statistic, 2)
p_val  <- wilcox_res$p.value

#label_text <- bquote(chi^2 * "(" * "df = " * .(df) * ")" == .(format(chi_sq, format="g", digits=3)) * "," ~ italic(p) == .(signif(p_val, 3)))
label_text <- sprintf("italic(W) == %g * ',' ~ italic(p) == %s", 
                      signif(W,3), signif(p_val, 3))

set.seed(123)
p <- ggplot(genome_size[genome_size$timepoint %in% c(3,4,8),], aes(x=factor(treatment3), y=genome_size/1000000)) +
  geom_half_violin(side = "r", aes(fill = treatment3), color=NA, alpha=1, position = position_dodge(width = 0.8)) +
  geom_half_boxplot(side = "r", errorbar.draw = FALSE, width=0.2, linewidth=0.5, alpha = 1, 
                    position = position_dodge(width = 0.8), outlier.size = 2.5, outlier.alpha = 1) +
  geom_jitter(aes(x = as.numeric(factor(treatment3)) - 0.15, color = treatment3),
              width = 0.05, alpha = 1, size = 2) +
  ggplot2::annotate("text", x = "control", y = 6.3, label = label_text, size = 8, hjust = 0.2, parse = TRUE) +
  scale_fill_manual(name = "Treatment", values = c("control" = "royalblue", 
                               "drought" = "orange"), labels =c("control" = "Control\n(TP3, 4, 8)",
                                                                 "drought" = "Pre-flowering drought\n(TP3, 4, 8)")) +
  scale_color_manual(name = "Treatment", values = c("control" = "royalblue",
                                "drought" = "orange"), labels =c("control" = "Control\n(TP3, 4, 8)",
                                                                  "drought" = "Pre-flowering drought\n(TP3, 4, 8)")) +
  # annotate(geom = "text", x="control", y=3, label="n = 6", size = 8) +
  # annotate(geom = "text", x="drought", y=3, label="n = 6", size = 8)+
  labs(title = "Prokaryotes", y="CWM genome size (Mb)", x=NULL) +
  ylim(3, 6.5) +
  theme_bw()+
  theme(plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.y = element_text(size = 22, color="black"),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_text(size=26),
        legend.text = element_text(size=22),
        legend.title = element_text(size=26, vjust=2),
        legend.key.spacing.y = unit(0.5,"cm"))

  # 834 500

print(p)

```


## Fig.S4c_Prokaryotic genome size post-flowering drought
```{r, fig.align='center', fig.height=7.2, fig.width=4.5, warning=FALSE, message=FALSE}

wilcox_res <- wilcox.test(genome_size/1000000 ~ treatment, data = genome_size[genome_size$timepoint %in% c(10,11) & genome_size$treatment != "rewatering_pre_drought",])

W <- round(wilcox_res$statistic, 2)
p_val  <- wilcox_res$p.value

#label_text <- bquote(chi^2 * "(" * "df = " * .(df) * ")" == .(format(chi_sq, format="g", digits=3)) * "," ~ italic(p) == .(signif(p_val, 3)))
label_text <- sprintf("italic(W) == %g * ',' ~ italic(p) == %s", 
                      signif(W,3), signif(p_val, 3))
set.seed(123)
p <- ggplot(genome_size[genome_size$timepoint %in% c(10,11) & genome_size$treatment != "rewatering_pre_drought",], aes(x=factor(treatment3), y=genome_size/1000000)) +
  geom_half_violin(side = "r", aes(fill = treatment3), color=NA, alpha=1, position = position_dodge(width = 0.8)) +
  geom_half_boxplot(side = "r", errorbar.draw = FALSE, width=0.2, linewidth=0.5, alpha = 1, 
                    position = position_dodge(width = 0.8), outlier.size = 2.5, outlier.alpha = 1) +
  geom_jitter(aes(x = as.numeric(factor(treatment3)) - 0.15, color = treatment3),
              width = 0.05, alpha = 1, size = 2) +
  ggplot2::annotate("text", x = "control", y = 4.8, label = label_text, size = 8, hjust = 0.2, parse = T) +
  scale_fill_manual(name = "Treatment", values = c("control" = "royalblue", 
                                                   "drought" = "chocolate"), labels =c("control" = "Control\n(TP10, 11)",
                                                                                    "drought" = "Post-flowering drought\n(TP10, 11)")) +
  scale_color_manual(name = "Treatment", values = c("control" = "royalblue",
                                                    "drought" = "chocolate"), labels =c("control" = "Control\n(TP10, 11)",
                                                                                     "drought" = "Post-flowering drought\n(TP10, 11)")) +
  # annotate(geom = "text", x="control", y=3, label="n = 4", size = 8) +
  # annotate(geom = "text", x="drought", y=3, label="n = 4", size = 8)+
  labs(title = "Prokaryotes", y="CWM Genome size (Mb)", x=NULL) +
  ylim(3.1, 4.9) +
  theme_bw()+
  theme(plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.y = element_text(size = 22, color="black"),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_text(size=26),
        legend.text = element_text(size=22),
        legend.title = element_text(size=26, vjust=2),
        legend.key.spacing.y = unit(0.5,"cm"),
        legend.position = "bottom",
        legend.direction = "vertical")

# 450 720
# 555 720
print(p)

```



## Fig.S4d_Prokaryotic genome size all
```{r, fig.align='center', fig.height=5.8, fig.width=10.2, warning=FALSE, message=FALSE}

genome_size2 <- genome_size %>%
  group_by(timepoint, treatment, treatment2) %>%
  summarise(
    mean_genome_size = mean(genome_size),
    se_genome_size = sd(genome_size) / sqrt(n())  # standard deviation
  )

genome_size2$treatment <- factor(genome_size2$treatment, levels = c("control", "pre_drought", "post_drought","rewatering_pre_drought"))

p <- ggplot(genome_size2, aes(x = factor(paste0("TP",timepoint), levels = c(paste0("TP",c(3,4,8,9,10,11)))), 
                         y = mean_genome_size/1000000, 
                         color = treatment, 
                         group = treatment2)) + 
  geom_point(size = 6, alpha=0.8) + 
  geom_line(linewidth = 1.2) + 
  scale_color_manual(name="Treatment", values = c("control" = "royalblue",
                                                  "post_drought" = "chocolate",
                                                  "pre_drought" = "orange",
                                                  "rewatering_pre_drought" = "skyblue"), 
                     label=c("control"="Control",
                             "post_drought"="Post-flowering drought",
                             "pre_drought"="Pre-flowering drought",
                             "rewatering_pre_drought"="Rewatering pre-flowering drought")) +
  geom_errorbar(aes(ymin = (mean_genome_size - se_genome_size)/1000000, ymax = (mean_genome_size + se_genome_size)/1000000), width = 0.15, linewidth = 1.2) + 
  labs(x = "Time point (in weeks)", y = "Average genome Size (Mb)", title = "Prokaryotes") + 
  scale_y_continuous(labels = scales::comma)+
  theme_bw() +
  theme(plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.y = element_text(size = 22, color="black"),
        axis.text.x = element_text(size = 22, color="black"),
        axis.title = element_text(size=26),
        legend.text = element_text(size=22),
        legend.title = element_text(size=26, vjust=2),
        legend.key.spacing.y = unit(0.5,"cm"))
# 1020 580
print(p)