---
title: "Fig.S1b_Fungal genome size each site in field survey"
author: "Huanhuan Zhu"
date: "2025-09-24"
output: html_document
---

```{r, fig.align='center', fig.height=5, fig.width=12, warning=FALSE, message=FALSE}

library(ggplot2)
library(ggpubr)
library(dplyr)
library(gghalves)
library(agricolae)
##############fungi traits-rrncorrected############


rm(list=ls())
setwd("E:/Functrait/Result/Fungi/otu2/")

metadata <- read.csv("metadata.csv")

otu_all0 <- read.csv("otu_fungFlattening_rrncor.csv",row.names = 1)
#otu_all0 <- otu_all0[rowSums(otu_all0) > 0, ]

table(colSums(otu_all0) >0 )


otu_all0 <- apply(otu_all0, 2, function(x) x / sum(x) * 100)
table(colSums(otu_all0))

otu_id <- read.csv("FUNTRAIT.fung.OTU.ID1.csv")
colnames(otu_id)[13:18] <- c("phylum", "class", "order", "family", "genus", "species")


# check NA data
table(is.na(otu_id$phylum))
table(is.na(otu_id$class))
table(is.na(otu_id$order))
table(is.na(otu_id$family))
table(is.na(otu_id$genus))
table(is.na(otu_id$species))

otu_id$phylum <- gsub("p__", "p_", otu_id$phylum)
otu_id$class <- gsub("c__", "c_", otu_id$class)
otu_id$order <- gsub("o__", "o_", otu_id$order)
otu_id$family <- gsub("f__", "f_", otu_id$family)
otu_id$genus <- gsub("g__", "g_", otu_id$genus)
otu_id$species <- gsub("s__", "s_", otu_id$species)


fungi_traits <- read.csv("traits/rCNV_rlt_taxa_spl_GSGN_new.csv")


metadata1_s <- aggregate(cbind(Assembly_Length, Both_ITS_LSU) ~ Name.y, fungi_traits, FUN = "mean")
metadata1_g <- aggregate(cbind(Assembly_Length, Both_ITS_LSU) ~ Gen, fungi_traits, FUN = "mean")
metadata1_f <- aggregate(cbind(Assembly_Length, Both_ITS_LSU) ~ fam, fungi_traits, FUN = "mean")
metadata1_o <- aggregate(cbind(Assembly_Length, Both_ITS_LSU) ~ ord, fungi_traits, FUN = "mean")
metadata1_c <- aggregate(cbind(Assembly_Length, Both_ITS_LSU) ~ cla, fungi_traits, FUN = "mean")
metadata1_p <- aggregate(cbind(Assembly_Length, Both_ITS_LSU) ~ phy, fungi_traits, FUN = "mean")


metadata1_s$level <- "species"
metadata1_g$level <- "genus"
metadata1_f$level <- "family"
metadata1_o$level <- "order"
metadata1_c$level <- "class"
metadata1_p$level <- "phylum"


colnames(metadata1_s)[1] <- "taxon"
colnames(metadata1_g)[1] <- "taxon"
colnames(metadata1_f)[1] <- "taxon"
colnames(metadata1_o)[1] <- "taxon"
colnames(metadata1_c)[1] <- "taxon"
colnames(metadata1_p)[1] <- "taxon"



# 合并所有层级
metadata1_all <- bind_rows(metadata1_s, metadata1_g, metadata1_f,
                           metadata1_o, metadata1_c, metadata1_p)


otu_id$taxon_try <- ifelse(otu_id$species %in% metadata1_s$taxon, otu_id$species,
                           ifelse(otu_id$genus %in% metadata1_g$taxon, otu_id$genus,
                                  ifelse(otu_id$family %in% metadata1_f$taxon, otu_id$family,
                                         ifelse(otu_id$order %in% metadata1_o$taxon, otu_id$order,
                                                ifelse(otu_id$class %in% metadata1_c$taxon, otu_id$class,
                                                       ifelse(otu_id$phylum %in% metadata1_p$taxon, otu_id$phylum,
                                                              NA))))))


otu_id_with_traits <- left_join(otu_id, metadata1_all, by = c("taxon_try" = "taxon"))
otu_id_with_traits[is.na(otu_id_with_traits$Both_ITS_LSU),]$Both_ITS_LSU = mean(fungi_traits[!is.na(fungi_traits$Both_ITS_LSU),]$Both_ITS_LSU)
otu_id_with_traits[is.na(otu_id_with_traits$Assembly_Length),]$Assembly_Length = mean(fungi_traits[!is.na(fungi_traits$Assembly_Length),]$Assembly_Length)


saveRDS(otu_id_with_traits, "E:/Functrait/Result/Fungi/otu2/traits/otu_id_with_traits.rds")

#####################

otu_all_gs <- as.data.frame(otu_all0)
otu_all_gs$OTU.ID <- rownames(otu_all_gs)
otu_all_gs <- left_join(otu_all_gs, otu_id_with_traits[,c("OTU.ID","Assembly_Length")], by="OTU.ID")



otu_all_rrna <- as.data.frame(otu_all0)
otu_all_rrna$OTU.ID <- rownames(otu_all_rrna)
otu_all_rrna <- left_join(otu_all_rrna, otu_id_with_traits[,c("OTU.ID","Both_ITS_LSU")], by="OTU.ID")



otu_all_gs1 <- otu_all_gs
for (i in (1:(ncol(otu_all_gs1)-2))){
  otu_all_gs1[,i] <-  otu_all_gs1[,i] * otu_all_gs1[,ncol(otu_all_gs1)]/100000000
}

otu_all_gs2 <- as.data.frame(colSums(otu_all_gs1[,1:(ncol(otu_all_gs1) -2)]))
colnames(otu_all_gs2) <- "genome_size"
otu_all_gs2$runningSampleID <- rownames(otu_all_gs2)



otu_all_rrna1 <- otu_all_rrna
for (i in (1:(ncol(otu_all_rrna1)-2))){
  otu_all_rrna1[,i] <-  otu_all_rrna1[,i] * otu_all_rrna1[,ncol(otu_all_rrna1)]/100
}

otu_all_rrna2 <- as.data.frame(colSums(otu_all_rrna1[,1:(ncol(otu_all_rrna1) -2)]))
colnames(otu_all_rrna2) <- "rrna"
otu_all_rrna2$runningSampleID <- rownames(otu_all_rrna2)



otu_all_gs2 <- merge(otu_all_gs2, metadata, by="runningSampleID")
otu_all_gs2$ai2000 <- 1-1/otu_all_gs2$ai2000
otu_all_gs2$ai2022 <- 1-1/otu_all_gs2$ai2022

otu_all_gs2$type <- factor(otu_all_gs2$type,levels = c("Z", "B", "W"))

otu_all_gs2 <- otu_all_gs2[!(otu_all_gs2$site %in% sprintf("S%02d", 14)) ,]
otu_all_gs2$sampleType <- factor(otu_all_gs2$sampleType, levels=c('rhizosphere soil (Z)', 'bulk soil (B)', 'wild soil (W)'))

otu_all_gs3 <- otu_all_gs2[!(otu_all_gs2$site %in% sprintf("S%02d", 14)) ,]
otu_all_gs3$sampleType <- factor(otu_all_gs3$sampleType, levels=c('rhizosphere soil (Z)', 'bulk soil (B)', 'wild soil (W)'))


df <- NULL
for (i in unique(otu_all_gs3$site)){
  result_tmp <- with(otu_all_gs3[otu_all_gs3$site == i,],kruskal(genome_size,sampleType,group=TRUE))
  df_tmp <- data.frame("site" = rep(i,3), 
                       "sampleType" = rownames(result_tmp$groups), 
                       "label" = as.character(result_tmp$groups$groups),
                       "p" = as.numeric(result_tmp$statistics$p.chisq),
                       "max" = as.numeric(result_tmp$means[rownames(result_tmp$groups),]$Max))
  
  df <- rbind(df, df_tmp)
}

df$sampleType <- factor(df$sampleType, levels = levels(otu_all_gs3$sampleType))

df$label2 = " "
df[df$p < 0.001, "label2"] = "***"
df[df$p >= 0.001 & df$p < 0.01, "label2"] <- "**"
df[df$p >= 0.01 & df$p < 0.05, "label2"] <- "*"

df[df$label2 == " ", "label"] <- " "


ai2000_site <- aggregate(ai2000~site,otu_all_gs3,FUN = "mean")
ai2000_site$ai2000 <- (1/ai2000_site$ai2000)
ai2000_site <- ai2000_site[order(ai2000_site$ai2000, decreasing = T),]


p <- ggplot(otu_all_gs3, aes(x=factor(site, levels=c(ai2000_site$site)), y=genome_size, fill = sampleType)) +
  geom_boxplot(width = 0.6, outlier.size = 0.5, position = position_dodge(width = 0.75)) +
  geom_text(data = df,
            aes(x = factor(site), y =  max  + 7 , label = label, group = sampleType),
            position = position_dodge(width = 0.75),
            vjust = 0, size = 5) +
  geom_text(data = df,
            aes(x = factor(site), y = 20, label = label2),
            vjust = 0, size = 5) +
  scale_fill_manual(name="Type",values = rev(c("#cd1936","#40b3b3","#1445f8")),labels =c(
    'bulk soil (B)' = "Maizeland\nbulk soil",
    'rhizosphere soil (Z)' = "Maize\nRhizosphere",
    'wild soil (W)' = "Wildland\nsoil"
  )) +
  labs(x="Site (Aridity increasing →)", y="CWM genome size (Mb)", title="Fungi") +
  theme_bw() +
  theme(plot.title = element_text(color = "black", size = 20, hjust = 0.5),
        #axis.title.x = element_text(color = "black", size = 14), 
        axis.title = element_text(color = "black", size = 16), 
        axis.text.y = element_text(color = "black", size = 14),
        axis.text.x = element_text(color = "black", size = 14, angle = 45, hjust = 1),
        legend.title = element_text(color = "black", size = 16, vjust=2),
        legend.text = element_text(color = "black", size = 14),
        legend.key.spacing.y = unit(0.5,"cm"),
        strip.text = element_text(color = "black",size = 14),
        strip.background =element_rect(fill="lightgrey", size = 0)
  )

print(p)

#12 5
```
