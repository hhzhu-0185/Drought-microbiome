---
title: "Fig.S3c & Fig.S3d Average genome size of differential OTUs"
author: "Huanhuan Zhu"
date: "2025-10-09"
output: html_document
---


## Prokaryotes
```{r, fig.align='center', fig.height=6.2, fig.width=8.5, warning=FALSE, message=FALSE}


library(ggrepel)
library(ggplot2)
library(tidyverse)
library(ggpubr)
library(gghalves)
library(Maaslin2)
library(data.table)
library(ggh4x)
library(rstatix)

rm(list=ls())

setwd("E:/Functrait/Result/Bacteria/otu2/")

otu_all0 <- as.data.frame(fread("otu_bacteriaFlattening_rrncor.csv"))
otu_all0 <- column_to_rownames(otu_all0,"V1")
otu_all0 <- as.data.frame(t(otu_all0))


otu_all0$runningSampleID <- rownames(otu_all0)

metadata <- read.csv("metadata.csv")

otu_all1 <- merge(otu_all0, metadata[,c("runningSampleID","ai2000","type")], by="runningSampleID")
otu_all1_z <- otu_all1[otu_all1$type=="Z",]
otu_all1_z$ai2000 <- 1-1/otu_all1_z$ai2000

otu_all1_z <- otu_all1_z[!grepl("S14", otu_all1_z$runningSampleID),]


rownames(otu_all1_z) <- NULL
otu_all1_z <- column_to_rownames(otu_all1_z,"runningSampleID")


metadata <-data.frame("id" = rownames(otu_all1_z), "ai2000" = otu_all1_z$ai2000) 
metadata <- column_to_rownames(metadata,"id")

fit_data <- Maaslin2(
  input_data = otu_all1_z[,1:16713],
  input_metadata = metadata,
  min_abundance = 0.001,
  min_prevalence = 0.01,
  min_variance = 0.0,
  output = "D:/Rtmp",
  normalization = "NONE",
  transform = "LOG",
  analysis_method = "LM",
  fixed_effects = c("ai2000"),
  random_effects = NULL,
  plot_scatter = FALSE
)
rp1 <- fit_data$results
colnames(rp1)[1] = "otu"

rp1$type <- "none"
rp1[rp1$coef > 0.00 & rp1$qval <0.05,]$type <- "Up"
rp1[rp1$coef <= 0.00 & rp1$qval <0.05,]$type <- "Down"
rp1[rp1$qval >= 0.05,]$type <- "Stable"
############

group <- read.csv("FUNTRAIT.bact.OTU.ID1.csv")
qiime2 <- read.csv("E:/Functrait/Result/Bacteria/qiime2/FUNTRAIT.bact.OTU.ID1.csv")
# 
# table(blast2$V1 %in% group$V1)

#saveRDS(blast2,"./hmsc/blast2.RDS")
blast2 <- readRDS("gtdb/blast_gtdb.RDS")
#blast2 <- blast2[blast2$V9 >70 & blast2$V12 >90,]
blast3 <- merge(blast2, group[, c("V1", "OTU.ID")], by.x="Feature.ID", by.y="V1")
blast3 <- blast3[,c("OTU.ID","genome_size")]


rp1 <- separate(rp1, otu, sep = "\\.", into = "otu")
blast3 <- separate(blast3, OTU.ID, sep = "\\.", into = "OTU.ID")

rp1 <- left_join(rp1, blast3, by=c("otu"="OTU.ID"))
rp1 <- left_join(rp1, group, by=c("otu"="V1"))

rp1 <- rp1[!is.na(rp1$genome_size),]

kruskal_res <- kruskal.test(genome_size/1000000 ~ type, data = rp1)


chi_sq <- round(kruskal_res$statistic, 2)
p_val  <- kruskal_res$p.value
df_new <- kruskal_res$parameter

label_text <- sprintf("chi^2 * '(' * 'df = %d' * ')' == %g * ',' ~ italic(p) == %s", 
                      df_new, signif(chi_sq, 3), formatC(p_val, format="e", digits=2))


# paired wilcox and p value adjust
res <- rp1 %>%
  pairwise_wilcox_test(genome_size ~ type, p.adjust.method = "fdr")

res

labels <- sprintf("italic(p) == '%s'", format(res$p.adj, scientific = TRUE, digits = 3))
labels[1] = "italic(p) == '0.001'"

count <- as.data.frame(table(rp1$type))
count$all <- paste0("n = ", count$Freq) 

sd_df <- aggregate(genome_size ~ type, rp1, FUN = "sd")
colnames(sd_df)[2] <- "sd"

mean_df <- aggregate(genome_size ~ type, rp1, FUN = "mean")
colnames(mean_df)[2] <- "mean"

merged_df <- merge(mean_df, sd_df, by = "type")
merged_df$all <- paste0(round(merged_df$mean/1000000, 2), " ± ", round(merged_df$sd/1000000, 2))

my_comparisons <- list(c("Up", "Down"), c("Stable", "Down"), c("Stable", "Up"))
rp1$type <- factor(rp1$type, levels=c("Up","Down", "Stable"))

p <- ggplot(rp1, aes(x=type, y=genome_size/1000000)) +
  geom_half_violin(side = "r", aes(fill = type), color=NA, alpha=0.6, position = position_dodge(width = 0.8)) +
  geom_half_boxplot(side = "r", errorbar.draw = FALSE, width=0.2, linewidth=0.5, 
                    position = position_dodge(width = 0.8), outlier.size = 0.8, outlier.alpha = 0.6) +
  geom_jitter(aes(x = as.numeric(factor(type)) - 0.15, color = type), 
              shape = 21, size=0.1, alpha = 0.6, width = 0.05) +
  scale_x_discrete( labels = c(
    'Up' = "Increase",
    'Stable' = "Stable",
    'Down' = "Decrease"
  )) +
  scale_fill_manual(name = "Type", 
                    values = c("#cd1936","#1445f8","#40b3b3"), 
                    labels = c(
                      'Up' = "Increase\nwith aridity",
                      'Stable' = "Non-\nsignificant",
                      'Down' = "Decrease\nwith aridity"
                    )) +
  scale_color_manual(name = "Type", 
                     values = c("#cd1936","#1445f8","#40b3b3"), 
                     labels = c(
                       'Up' = "Increase\nwith aridity",
                       'Stable' = "Non-\nsignificant",
                       'Down' = "Decrease\nwith aridity"
                     )) +
  labs(x ="Sample type", title = "Prokaryotes", y="Average genome size (Mb)") +
  geom_text(data = count, aes(x=Var1, y=-2.5, label=all), color="black", size=8) +
  geom_text(data = merged_df, aes(x=type, y=-0.5, label=all), color="black", size=8) +
  # stat_compare_means(label.y = 27, method = "kruskal.test", size=8) +
  ggplot2::annotate("text", x = "Up", y = 27, label = label_text, size = 8, hjust = 0.18, parse = TRUE) +
  geom_signif(data = res, aes(y_position =  c(17.5, 14, 21), 
                              xmin = group1, 
                              xmax = group2, 
                              annotations = labels, tip_length = 0.02),
              manual = TRUE, textsize = 8, parse = T)+
  ylim(-3,28) +
  theme_bw() +
  theme(plot.title = element_text(color = "black", size = 30, hjust = 0.5),
        axis.title = element_text(color = "black", size = 26), 
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(color = "black", size = 22),
        legend.title = element_text(color = "black", size = 26, vjust=2),
        legend.text = element_text(color = "black", size = 22),
        legend.key.spacing.y = unit(0.5,"cm"),
        strip.text = element_text(color = "black",size = 22),
        strip.background =element_rect(fill="lightgrey", size = 0)
  )


print(p)

#850 620
```


## Fungi
```{r, fig.align='center', fig.height=6.2, fig.width=8.7, warning=FALSE, message=FALSE}
rm(list=ls())

setwd("E:/Functrait/Result/Fungi/otu2/")

otu_all0 <- as.data.frame(fread("otu_fungFlattening_rrncor.csv"))
otu_all0 <- column_to_rownames(otu_all0,"V1")
otu_all0 <- as.data.frame(t(otu_all0))


otu_all0$runningSampleID <- rownames(otu_all0)

metadata <- read.csv("metadata.csv")

otu_all1 <- merge(otu_all0, metadata[,c("runningSampleID","ai2000","type")], by="runningSampleID")
otu_all1_z <- otu_all1[otu_all1$type=="W",]
otu_all1_z$ai2000 <- 1-1/otu_all1_z$ai2000

otu_all1_z <- otu_all1_z[!grepl("S14", otu_all1_z$runningSampleID),]


rownames(otu_all1_z) <- NULL
otu_all1_z <- column_to_rownames(otu_all1_z,"runningSampleID")


metadata <-data.frame("id" = rownames(otu_all1_z), "ai2000" = otu_all1_z$ai2000) 
metadata <- column_to_rownames(metadata,"id")

fit_data <- Maaslin2(
  input_data = otu_all1_z[,1:(ncol(otu_all1_z)-2)],
  input_metadata = metadata,
  min_abundance = 0.001,
  min_prevalence = 0.01,
  min_variance = 0.0,
  output = "D:/Rtmp",
  normalization = "NONE",
  transform = "LOG",
  analysis_method = "LM",
  fixed_effects = c("ai2000"),
  random_effects = NULL,
  plot_scatter = FALSE
)
rp1 <- fit_data$results
colnames(rp1)[1] = "otu"

rp1$type <- "none"
rp1[rp1$coef > 0.00 & rp1$qval <0.05,]$type <- "Up"
rp1[rp1$coef <= 0.00 & rp1$qval <0.05,]$type <- "Down"
rp1[rp1$qval >= 0.05,]$type <- "Stable"

otu_id_with_traits <- readRDS("traits/otu_id_with_traits.rds")


rp1 <- left_join(rp1, otu_id_with_traits, by=c("otu"="OTU.ID"))

rp1 <- separate(rp1, genus, sep = "_", into=c("pre_genus", "genus"))

rp1 <- rp1[!is.na(rp1$Assembly_Length),]

kruskal_res <- kruskal.test(Assembly_Length/1000000 ~ type, data = rp1)

chi_sq <- round(kruskal_res$statistic, 2)
p_val  <- kruskal_res$p.value
df_new <- kruskal_res$parameter

label_text <- sprintf("chi^2 * '(' * 'df = %d' * ')' == %g * ',' ~ italic(p) == %s", 
                      df_new, signif(chi_sq, 3), formatC(p_val, format="e", digits=2))

# paired wilcox and p value adjust
res <- rp1 %>%
  pairwise_wilcox_test(Assembly_Length ~ type, p.adjust.method = "fdr")

labels <- sprintf("italic(p) == '%s'", format(res$p.adj, scientific = TRUE, digits = 3))
labels[3] = "italic(p) == '0.004'"

count <- as.data.frame(table(rp1$type))
count$all <- paste0("n = ", count$Freq) 

sd_df <- aggregate(Assembly_Length ~ type, rp1, FUN = "sd")
colnames(sd_df)[2] <- "sd"

mean_df <- aggregate(Assembly_Length ~ type, rp1, FUN = "mean")
colnames(mean_df)[2] <- "mean"

merged_df <- merge(mean_df, sd_df, by = "type")
merged_df$all <- paste0(round(merged_df$mean/1000000, 2), " ± ", round(merged_df$sd/1000000, 2))


my_comparisons <- list(c("Up", "Down"), c("Stable", "Down"), c("Stable", "Up"))
rp1$type <- factor(rp1$type, levels=c("Up","Down", "Stable"))

p <- ggplot(rp1, aes(x=type, y=Assembly_Length/1000000)) +
  geom_half_violin(side = "r", aes(fill = type), color=NA, alpha=0.6, position = position_dodge(width = 0.8)) +
  geom_half_boxplot(side = "r", errorbar.draw = FALSE, width=0.2, linewidth=0.5, alpha=0.5, 
                    position = position_dodge(width = 0.8), outlier.size = 0.8, outlier.alpha = 0.6) +
  geom_jitter(aes(x = as.numeric(factor(type)) - 0.15, color = type), 
              shape = 21, size=0.1, alpha = 0.6, width = 0.05) +
  scale_fill_manual(name = "Type", 
                    values = c("#cd1936","#1445f8","#40b3b3"), 
                    labels = c(
                      'Up' = "Increase\nwith aridity",
                      'Stable' = "Non-\nsignificant",
                      'Down' = "Decrease\nwith aridity"
                    )) +
  scale_color_manual(name = "Type", 
                     values = c("#cd1936","#1445f8","#40b3b3"), 
                     labels = c(
                       'Up' = "Increase\nwith aridity",
                       'Stable' = "Non-\nsignificant",
                       'Down' = "Decrease\nwith aridity"
                     )) +
  scale_x_discrete( labels = c(
    'Up' = "Increase",
    'Stable' = "Stable",
    'Down' = "Decrease"
  )) +
  geom_text(data = count, aes(x=Var1, y=-20, label=all), color="black", size=7) +
  geom_text(data = merged_df, aes(x=type, y=0, label=all), color="black", size=7) +
  labs(x ="Sample type", title = "Fungi", y="Average genome size (Mb)") +
  ylim(-20,345) +
  ggplot2::annotate("text", x = "Up", y = 335, label = label_text, size = 8, hjust = 0.18, parse = TRUE) +
  geom_signif(data = res, aes(y_position = c(225, 185, 265), 
                              xmin = group1, 
                              xmax = group2, 
                              annotations = labels, tip_length = 0.02),
              manual = TRUE, textsize = 8, parse = T)+
  theme_bw() +
  theme(plot.title = element_text(color = "black", size = 30, hjust = 0.5),
        axis.title = element_text(color = "black", size = 26), 
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(color = "black", size = 22),
        legend.title = element_text(color = "black", size = 26, vjust=2),
        legend.text = element_text(color = "black", size = 22),
        legend.key.spacing.y = unit(0.5,"cm"),
        strip.text = element_text(color = "black",size = 22),
        strip.background =element_rect(fill="lightgrey", size = 0)
  )



print(p)

#870 620

```
