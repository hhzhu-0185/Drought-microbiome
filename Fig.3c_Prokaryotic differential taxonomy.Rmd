---
title: "Fig.3c_Prokaryotic differential taxonomy"
author: "Huanhuan Zhu"
date: "2025-10-09"
output: html_document
---

```{r, fig.align='center', fig.height=5.0, fig.width=10.5, warning=FALSE, message=FALSE}


#############################Fig.3c_Prokaryotic differential taxonomy##########################

library(dplyr)  # to use count/everything
library(RColorBrewer)
library(tidyverse)  # %>%
library(reshape2)  # melt
library(patchwork)
library(ggplot2)
library(ggh4x)
library(Maaslin2)
library(data.table)

rm(list=ls())

setwd("E:/HMME/Metagenome/Result_new/kaiju")

#kaiju_calculation <- function(title, path1){

path <- paste0("E:/HMME/Metagenome/Result_new/kaiju/","all")
fileNames <- dir(path) 
filePath <- sapply(fileNames, function(x){paste(path , x, sep= '/')})   

data <- lapply(filePath, function(x){read.csv(x, sep = "\t")})  

data2 <- list()
data_bac <- list()
data_euk <- list()
data2_info <- NULL

# for (i in 1:length(data)){
#   data_tmp <- data[[i]]
#   data_tmp <- data_tmp[1:(nrow(data_tmp)-3),] 
#   data_tmp <- separate(data_tmp, col = taxon_name, into = c("superkingdom","kingdom","phylum","class","order","family","genus","species"), sep = ";") 
#   #data_tmp <- data_tmp[data_tmp$superkingdom != "Eukaryota", ]
#   #data_tmp$Taxon <- ifelse(data_tmp$Taxon == "", data_tmp$Phylum, paste0(data_tmp$Phylum, "_", data_tmp$Taxon))
#   #data_tmp <- na.omit(data_tmp[,c(1:3, 5, 7)])
#   
#   data_tmp2 <- data_tmp[ ,4:12]
#   
#   rename1 <- gsub("./", "", data_tmp[1,1])
#   rename2 <- gsub(".kaiju.out", "", rename1)
#   colnames(data_tmp)[3] <- rename2
#   
#   data_tmp_bac <- data_tmp[data_tmp$superkingdom != "Eukaryota", ]
#   data_tmp_bac[ ,2] <- (data_tmp_bac[ ,2] / sum(data_tmp_bac[ ,2])) * 100
#   data_tmp_bac <- data_tmp_bac[ ,c(3,4)]
#   
#   data_tmp_euk <- data_tmp[data_tmp$superkingdom == "Eukaryota",]
#   data_tmp_euk[ ,2] <- (data_tmp_euk[ ,2] / sum(data_tmp_euk[ ,2])) * 100
#   data_tmp_euk <- data_tmp_euk[ ,c(3,4)]
#   
#   data2_info <- rbind(data2_info, data_tmp2)
#   data2_info <- data2_info[!duplicated(data2_info$taxon_id), ]
#   
#   data_bac[[i]] <- data_tmp_bac
#   data_euk[[i]] <- data_tmp_euk
#   data2[[i]] <- data_tmp
# }
# 
# kaiju_bac <- Reduce(function(x, y) merge(x, y, by = "taxon_id", all = TRUE), data_bac)
# #kaiju_bac <- kaiju_bac[!is.na(kaiju_bac$Taxon),]
# kaiju_bac[is.na(kaiju_bac)] <- 0
# kaiju_bac <- column_to_rownames(kaiju_bac,"taxon_id")
# 
# saveRDS(kaiju_bac,"kaiju_bac.RDS")
# saveRDS(data2_info,"data2_info.RDS")

kaiju_bac <- readRDS("kaiju_bac.RDS")
data2_info <- readRDS("data2_info.RDS")

otu_all1_z <- as.data.frame(t(kaiju_bac[,grepl("TS", colnames(kaiju_bac))]))


metadata <-data.frame("id" = rownames(otu_all1_z), "group" = as.numeric(substr(rownames(otu_all1_z),1,1))) 
metadata <- column_to_rownames(metadata,"id")

# fit_data <- Maaslin2(
#   input_data = otu_all1_z,
#   input_metadata = metadata,
#   min_abundance = 5,
#   min_prevalence = 0.2,
#   min_variance = 0.0,
#   output = "D:/Rtmp",
#   normalization = "CSS",
#   transform = "LOG",
#   analysis_method = "LM",
#   cores = 1,
#   fixed_effects = c("group"),
#   random_effects = NULL,
#   plot_scatter = FALSE
# )


# rp1 <- fit_data$results
# saveRDS(rp1, "rp1.RDS")

rp1 <- readRDS("rp1.RDS")
colnames(rp1)[1] = "otu"


rp1$type <- "none"
rp1[rp1$coef > 0.00 & rp1$qval <0.05,]$type <- "Up"
rp1[rp1$coef <= 0.00 & rp1$qval <0.05,]$type <- "Down"
rp1[rp1$qval >= 0.05,]$type <- "Stable"
############

rp1$otu <- as.integer(gsub("X","",rp1$otu))
rp2 <- left_join(rp1, data2_info, by=c("otu"="taxon_id"))

rp2 <- rp2[rp2$qval <0.05, ]


# W700 H500


my_function <- function(){
  otu_all_z<- as.data.frame(kaiju_bac[,grepl("TS", colnames(kaiju_bac))])
  
  otu_all_z$otu <- as.integer(rownames(otu_all_z))
  otu_all_z <- otu_all_z[otu_all_z$otu %in% rp2[rp2$coef > 0,]$otu, ]
  
  
  otu_all_z <- merge(otu_all_z, data2_info[,c("family","taxon_id")], by.x="otu", by.y="taxon_id")
  otu_all_z1 <- aggregate(.~family,otu_all_z[,2:ncol(otu_all_z)], FUN="sum")
  otu_all_z1 <- as.data.frame(t(column_to_rownames(otu_all_z1,"family")))
  otu_all_z1$runningSampleID <- substr(rownames(otu_all_z1), 1, 1)
  otu_all_z1 <- aggregate(.~runningSampleID,otu_all_z1[,2:ncol(otu_all_z1)], FUN="mean")
  otu_all_z2_up <- reshape2::melt(otu_all_z1, id="runningSampleID")
  otu_all_z2_up <- otu_all_z2_up[otu_all_z2_up$runningSampleID =="6",]
  otu_all_z2_up <- otu_all_z2_up[otu_all_z2_up$variable != "NA",]
  otu_all_z2_up1 <- as.character(otu_all_z2_up[order(otu_all_z2_up$value, decreasing = T)[1:10],"variable"])
  
  otu_all_z<- as.data.frame(kaiju_bac[,grepl("TS", colnames(kaiju_bac))])
  
  otu_all_z$otu <- as.integer(rownames(otu_all_z))
  otu_all_z <- otu_all_z[otu_all_z$otu %in% rp2[rp2$coef < 0,]$otu, ]
  
  
  otu_all_z <- merge(otu_all_z, data2_info[,c("family","taxon_id")], by.x="otu", by.y="taxon_id")
  otu_all_z1 <- aggregate(.~family,otu_all_z[,2:ncol(otu_all_z)], FUN="sum")
  otu_all_z1 <- as.data.frame(t(column_to_rownames(otu_all_z1,"family")))
  otu_all_z1$runningSampleID <- substr(rownames(otu_all_z1), 1, 1)
  otu_all_z1 <- aggregate(.~runningSampleID,otu_all_z1[,2:ncol(otu_all_z1)], FUN="mean")
  
  otu_all_z2_down <- reshape2::melt(otu_all_z1, id="runningSampleID")
  otu_all_z2_down <- reshape2::melt(otu_all_z1, id="runningSampleID")
  otu_all_z2_down <- otu_all_z2_down[otu_all_z2_down$runningSampleID =="1",]
  otu_all_z2_down <- otu_all_z2_down[otu_all_z2_down$variable != "NA",]
  otu_all_z2_down1 <- as.character(otu_all_z2_down[order(otu_all_z2_down$value, decreasing = T)[1:9],"variable"])
  
  otu_all_z2_tmp <<- unique(c(otu_all_z2_up1,otu_all_z2_down1))
  otu_all_z1 <<- reshape2::melt(otu_all_z1, id="runningSampleID")
  
}

my_function()
otu_all_order <- otu_all_z2_tmp[1:15]
# unique(otu_all_order$variable)


my_function <- function(){
  otu_all_z <- as.data.frame(kaiju_bac[,grepl("TS", colnames(kaiju_bac))])
  otu_all_z <- as.data.frame(apply(otu_all_z, 2, function(x) x / sum(x) * 100))
  
  otu_all_z$otu <- as.integer(rownames(otu_all_z))
  otu_all_z <- otu_all_z[otu_all_z$otu %in% rp2$otu, ]
  
  
  otu_all_z <- merge(otu_all_z, data2_info[,c("family","taxon_id")], by.x="otu", by.y="taxon_id", all.x = T)
  otu_all_z1 <- aggregate(.~family,otu_all_z[,2:ncol(otu_all_z)], FUN="sum")
  otu_all_z1 <- as.data.frame(t(column_to_rownames(otu_all_z1,"family")))
  otu_all_z1$runningSampleID <- substr(rownames(otu_all_z1), 1, 1)
  otu_all_z1 <- aggregate(.~runningSampleID,otu_all_z1[,2:ncol(otu_all_z1)], FUN="mean")
  
  otu_all_z2 <- reshape2::melt(otu_all_z1, id="runningSampleID")
  
  order_new1 <- aggregate(value~variable,otu_all_z2, FUN="mean")
  
  order_new1 <- order_new1[order(order_new1$value,decreasing = T),]
  order_new1 <- order_new1[order_new1$variable %in% unique(otu_all_order), ]
  
  levels(otu_all_z2$variable) <- c(levels(otu_all_z2$variable), "Others")

  otu_all_z2[!(otu_all_z2$variable %in% order_new1$variable),]$variable <- "Others"
  otu_all_z2_tmp <<- otu_all_z2
}

rp2 <- rp1[rp1$type=="Up", ]
my_function()
otu_all_z2_up <- otu_all_z2_tmp
otu_all_z2_up$type <- "Up"

rp2 <- rp1[rp1$type=="Down", ]
my_function()
otu_all_z2_down <- otu_all_z2_tmp
otu_all_z2_down$type <- "Down"


otu_all_z2_all <- rbind(otu_all_z2_up, otu_all_z2_down)

colors <- c(
  "#E41A1C", # red
  "#377EB8", # blue
  "#4DAF4A", # green
  "#984EA3", # purple
  "#FF7F00", # orange
  "#FFFF33", # yellow
  "#A65628", # dark brown
  "#F781BF", # pink
  "#666666", # gray
  "#1B9E77", # dark teal
  "#D95F02", # deep orange
  "#6495ED", # muted blue
  "#E7298A", # deep pink
  "#66A61E", # olive green
  "#A6761D", # dark mustard
  "gray"
)

otu_all_z2_all$type <- factor(otu_all_z2_all$type, levels = c("Up", "Down"))


# genome_size added
rp2 <- left_join(rp1, data2_info, by=c("otu"="taxon_id"))

rp2 <- rp2[rp2$qval <0.05, ]

metadata_bac <- as.data.frame(fread("D:/database/gtdb/bac120_metadata_r226.tsv"))
metadata_arc <- as.data.frame(fread("D:/database/gtdb/ar53_metadata_r226.tsv"))
metadata <- rbind(metadata_bac,metadata_arc)
rm(list=c("metadata_bac", "metadata_arc"))
metadata1 <- as.data.frame(metadata[,c("ncbi_taxid","genome_size")])
metadata1 <- aggregate(.~ncbi_taxid,metadata1, FUN = "mean")


rp2 <- left_join(rp2, metadata1, by=c("otu"="ncbi_taxid"))
rp3 <- rp2[!is.na(rp2$genome_size),]


# genome_size added
mean_gs <- aggregate(genome_size~ family, rp3, FUN="mean")
colnames(mean_gs)[2] <- "mean"

sd_gs <- aggregate(genome_size~ family, rp3, FUN="sd")
colnames(sd_gs)[2] <- "sd"

all_gs <- merge(mean_gs, sd_gs, by = "family")

all_gs$all <- paste0(all_gs$family,
                     " (", round(all_gs$mean/1000000,2), " Â± ",  round(all_gs$sd/1000000,2), " Mb)")


library(scales)
my_colors <- c(
  "Up" = alpha("#cd1936", 1),
  "Down" = alpha("#1445f8", 1)
)

strip_custom <- strip_themed(
  background_x = elem_list_rect(
    fill = my_colors,
    color = "black"
  ),
  text_x = elem_list_text(
    #face = "bold",
    colour = "white"
  )
)


# for rename fill
otu_all_z2_all <- merge(otu_all_z2_all, all_gs[,c("family","all")], by.x="variable", by.y="family", all.x = T)

phylum_labels <- unique(otu_all_z2_all[, c("variable", "all")])

phylum_labels_vec <- setNames(c(phylum_labels$all[1:15],"Others"), phylum_labels$variable)


p <-  ggplot(data = otu_all_z2_all, aes(x=runningSampleID,y=value/100,fill=factor(variable, levels = rev(c(as.character(otu_all_order),"Others"))))) +
      geom_col(position = "stack", width = 0.6)  +
      facet_wrap2(. ~ type,
                  strip = strip_custom,
                  labeller = labeller(type = c("Up" = "Increase", "Down" = "Decrease"))) +
      scale_fill_manual(name="Top 15 family",values =  rev(colors), labels = phylum_labels_vec) +
      scale_y_continuous(labels = scales::percent) +
      labs(x="Generation", y="Relative abundance (%)", title="Prokaryotes")+
      theme_bw() +
      theme(plot.title = element_text(color = "black", size = 30, hjust = 0.5),
            axis.title = element_text(color = "black", size = 26), 
            #axis.title.x = element_blank(), 
            axis.text.y = element_text(color = "black", size = 22),
            axis.text.x = element_text(color = "black", size = 22, angle = 0),
            legend.title = element_text(color = "black", size = 24),
            legend.text = element_text(color = "black", size = 20),
            strip.text = element_text(color = "black",size = 22),
            strip.background =element_rect(fill="lightgrey", size = 0)
      )


print(p)
  
```

