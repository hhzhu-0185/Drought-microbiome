---
title: "Fig.3b_Prokaryotic genome size in control experiment"
author: "Huanhuan Zhu"
date: "2025-10-09"
output: html_document
---

```{r, fig.align='center', fig.height=5.0, fig.width=10.5, warning=FALSE, message=FALSE}


library(ggplot2)
library(ggpubr)
library(agricolae)
library(scales)     
library(dplyr)
library(ggsignif)
library(rstatix)


rm(list=ls())

setwd("E:/HMME/Metagenome/Result_new/genomesize")
gsdata <- read.csv("genomesize_output.csv",header = TRUE)
aggregate(average_genome_size~generation+type, data = gsdata, FUN = "mean")


gsdata$type <- as.factor(gsdata$type)
gsdata$generation <- as.factor(gsdata$generation)

gsdata$type2 <- paste0(gsdata$type,gsdata$generation)

gsdata$group <- interaction(gsdata$generation, gsdata$type)

kruskal_result <- kruskal(gsdata$average_genome_size, gsdata$group, group = TRUE, p.adj = "BH")


letters_df <- kruskal_result$groups %>%
  mutate(group = rownames(.)) %>%
  select(group, groups) %>%
  rename(label = groups)


ypos <- gsdata %>%
  group_by(group) %>%
  reframe(y = max(average_genome_size), type=type, generation=generation) %>%
  left_join(letters_df, by = "group")

chisq_val <- kruskal_result$statistics[["Chisq"]]
p_val <- kruskal_result$statistics[["p.chisq"]]

rp.value <- sprintf("italic(p) == %.2f %%*%% 10^%.0f ~ (italic(chi^2) == %.3g)", 
                           p_val / 10^floor(log10(p_val)), 
                           floor(log10(p_val)), 
                           chisq_val)
                   

kruskal_res <- kruskal.test(average_genome_size/1000000 ~ group, data = gsdata)

chi_sq <- round(kruskal_res$statistic, 2)
p_val  <- kruskal_res$p.value
df <- kruskal_res$parameter

#label_text <- bquote(chi^2 * "(" * "df = " * .(df) * ")" == .(format(chi_sq, format="g", digits=3)) * "," ~ italic(p) == .(formatC(p_val, format="e", digits=2)))
label_text <- sprintf("chi^2 * '(' * 'df = %d' * ')' == %g * ',' ~ italic(p) == %s", 
                      df, chi_sq, formatC(p_val, format="e", digits=2))
set.seed(123)
p <- ggplot(data = gsdata, aes(x = generation, y = average_genome_size/1000000, color = factor(type))) +
  geom_boxplot(position = position_dodge(width = 0.75), outlier.shape = NA) +
  geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
              size = 1, alpha = 0.7) +
  geom_text(data = ypos, aes(x = generation, y = y/1000000 + 0.25, label = label, group = type), 
            position = position_dodge(width = 0.75), size = 8, color="black") +
  scale_y_continuous(
    breaks = ((4:8)-0.5),
    labels = number_format(accuracy = 0.1),
  limits=c(3.3,8.5)) +
  scale_color_manual(name="Treatment", values = c("blue", "red"),labels=c(
                                                                      "C2"="Non-iterative drought (control)",
                                                                      "T"="Iteration drought"
                                                                    )) +
  
  labs(x = "Generation", y = "CWM genome size (Mb)", title = "Prokaryotes") +
  ggplot2::annotate("text", x = 2, y = 8.4, label = label_text, size = 8, hjust = 0.22, parse = TRUE) +
  #annotate("text", x = 4, y = 8.4, label = rp.value, parse = TRUE, size = 8, color = "black") +
  theme_bw() +
  theme(plot.title = element_text(color = "black", size = 30, hjust = 0.5),
        #axis.title.x = element_text(color = "black", size = 16), 
        axis.title = element_text(color = "black", size = 26), 
        axis.text.y = element_text(color = "black", size = 22),
        axis.text.x = element_text(color = "black", size = 22),
        legend.title = element_text(color = "black", size = 26),
        legend.text = element_text(color = "black", size = 22),
        strip.text = element_text(color = "black",size = 22),
        strip.background =element_rect(fill="lightgrey", size = 0)
  )

print(p)

```
